@echo off
setlocal
pushd %~dp0

if [%1]==[] (
	echo.
	echo Usage: %~nx0 ^<VersionNo^> [push]
	echo.
	echo    where
	echo        VersionNo: Version number of the form Major.Minor.Patch ^(see http://semver.org/^)
	echo                   that will be applied to the assembly and the NuGet package.
	echo        push:      When this parameter is provided,  the script will automatically
	echo                   push the package to nuget.org.
	echo.
	goto :error
)
if /i [%2]==[push] (
	set SHOULD_PUSH=1
) else (
	set SHOULD_PUSH=
)
set THIS_DIR=%~dp0
set OUTPUT_DIR=%THIS_DIR%output
set TARGET_VERSION=%~1
set VERSION_INFO_FILE="%THIS_DIR%..\src\LpSolveDotNet\Properties\VersionInfo.cs"

if exist "%OUTPUT_DIR%" (
	echo.
	echo Remove "%OUTPUT_DIR%"
	rmdir /s /q "%OUTPUT_DIR%" || goto :error
)

echo.
echo Create "%OUTPUT_DIR%"
mkdir "%OUTPUT_DIR%" || goto :error

echo.
echo Update build number in assembly attributes
echo.
echo // This file was auto-generated by build process     > %VERSION_INFO_FILE%
echo using System.Reflection;                            >> %VERSION_INFO_FILE%
echo [assembly: AssemblyVersion("%TARGET_VERSION%")]     >> %VERSION_INFO_FILE%
echo [assembly: AssemblyFileVersion("%TARGET_VERSION%")] >> %VERSION_INFO_FILE%

echo.
echo Build project
msbuild "%THIS_DIR%..\src\LpSolveDotNet\LpSolveDotNet.csproj" /p:Configuration=Release "/p:OutputPath=%OUTPUT_DIR%" || goto :error

echo.
echo Build NuGet package
nuget pack "%THIS_DIR%LpSolveDotNet.nuspec" -Version "%TARGET_VERSION%" -OutputDirectory "%OUTPUT_DIR%" || goto :error

if [%SHOULD_PUSH%]==[1] (
	echo.
	echo Push package to NuGet
	nuget push "%OUTPUT_DIR%\LpSolveDotNet.%TARGET_VERSION%.nupkg" -Source https://www.nuget.org || goto :error
)
goto :end

:error
echo.
echo **********************************
echo Build failed, see above for errors
echo **********************************
echo.
popd
exit /b 1

:end
popd
exit /b 0
